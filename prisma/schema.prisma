generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id               String             @id @default(uuid())
  email            String             @unique
  password         String
  completeName     String
  avatar           String?
  phone            String?
  jobTitle         String?
  location         String?
  organization     String?
  timezone         String             @default("UTC")
  locale           String             @default("es")
  isActive         Boolean            @default(true)
  lastLogin        DateTime?
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  projectMembers   ProjectMember[]
  projectsCreated  Project[]          @relation("ProjectCreator")
  favorites        ProjectFavorite[]
  templateVersions TemplateVersion[]
  templatesCreated Template[]         @relation("TemplateCreator")
  userRoles        UserRole[]
  // Relations added for teams and communication modules
  teamsLed         Team[]            @relation("TeamLeader")
  teamMembers      TeamMember[]
  teamInvitations  TeamInvitation[]
  channelMemberships ChannelMember[]
  channelsCreated  Channel[]
  messages         Message[]
  reactions        Reaction[]
  presences        Presence[]
  // Friendships relations (inverse sides)
  friendships      Friendship[]       @relation("FriendUser")
  friendOf         Friendship[]       @relation("FriendTarget")
  // Call rooms relations
  callRoomsCreated CallRoom[]         @relation("CallRoomCreator")
  callParticipations CallParticipant[]

  @@map("users")
}

model Role {
  id          String     @id @default(uuid())
  name        String     @unique
  description String?
  permissions Json       @default("{}")
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  userRoles   UserRole[]

  @@map("roles")
}

model UserRole {
  id             String   @id @default(uuid())
  userId         String
  roleId         String
  organizationId String?
  assignedAt     DateTime @default(now())
  role           Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId, organizationId])
  @@map("user_roles")
}

model Project {
  id             String             @id @default(uuid())
  name           String
  description    String?
  code           String             @unique
  status         ProjectStatus      @default(ACTIVE)
  type           TemplateType       @default(SIMPLE)
  createdById    String
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  templateId     String?
  fases_proyecto fases_proyecto[]
  hitos          hitos[]
  members        ProjectMember[]
  favorites      ProjectFavorite[]
  createdBy      User               @relation("ProjectCreator", fields: [createdById], references: [id], onDelete: Cascade)
  template       Template?          @relation("ProjectTemplate", fields: [templateId], references: [id])
  tareas         tareas[]

  // Relations to teams & channels
  teams         Team[]
  channels      Channel[]

  @@map("projects")
}

model ProjectMember {
  id        String      @id @default(uuid())
  projectId String
  userId    String
  role      ProjectRole @default(MEMBER)
  addedAt   DateTime    @default(now())
  project   Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId])
  @@map("project_members")
}

model Template {
  id           String             @id @default(uuid())
  name         String             @unique
  description  String?
  category     TemplateCategory?
  industry     TemplateIndustry?
  complexity   TemplateComplexity @default(MEDIUM)
  content      Json
  isPublic     Boolean            @default(false)
  usageCount   Int                @default(0)
  rating       Decimal?           @db.Decimal(3, 2)
  createdById  String
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  templateType TemplateType?      @default(SIMPLE)
  projects     Project[]          @relation("ProjectTemplate")
  versions     TemplateVersion[]
  createdBy    User               @relation("TemplateCreator", fields: [createdById], references: [id], onDelete: Cascade)

  @@map("templates")
}

model TemplateVersion {
  id            String   @id @default(uuid())
  templateId    String
  versionNumber Int
  content       Json
  notes         String?
  createdById   String
  createdAt     DateTime @default(now())
  createdBy     User     @relation(fields: [createdById], references: [id])
  template      Template @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@unique([templateId, versionNumber])
  @@map("template_versions")
}

model adjuntos_tarea {
  id         String   @id
  taskId     String
  fileId     String?
  uploadedBy String?
  uploadedAt DateTime @default(now())
  tareas     tareas   @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([taskId], map: "idx_adjuntos_tarea")
}

model comentarios_tarea {
  id              String    @id
  taskId          String
  userId          String?
  content         String
  parentCommentId String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime
  deletedAt       DateTime?
  tareas          tareas    @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([parentCommentId], map: "idx_comentarios_padre")
  @@index([taskId], map: "idx_comentarios_tarea")
}

model dependencias_tareas {
  id                                                 String   @id
  taskId                                             String
  dependsOnTaskId                                    String
  dependencyType                                     String
  delayDays                                          Int      @default(0)
  createdAt                                          DateTime @default(now())
  tareas_dependencias_tareas_dependsOnTaskIdTotareas tareas   @relation("dependencias_tareas_dependsOnTaskIdTotareas", fields: [dependsOnTaskId], references: [id], onDelete: Cascade)
  tareas_dependencias_tareas_taskIdTotareas          tareas   @relation("dependencias_tareas_taskIdTotareas", fields: [taskId], references: [id], onDelete: Cascade)

  @@unique([taskId, dependsOnTaskId])
  @@index([taskId], map: "idx_dependencias_tarea")
}

model etiquetas {
  id               String             @id
  name             String
  color            String
  projectId        String?
  createdBy        String?
  createdAt        DateTime           @default(now())
  etiquetas_tareas etiquetas_tareas[]

  @@unique([name, projectId])
  @@index([projectId], map: "idx_etiquetas_proyecto")
}

model etiquetas_tareas {
  taskId    String
  tagId     String
  etiquetas etiquetas @relation(fields: [tagId], references: [id], onDelete: Cascade)
  tareas    tareas    @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@id([taskId, tagId])
  @@index([tagId], map: "idx_etiquetas_tareas_etiqueta")
}

model fases_proyecto {
  id          String    @id
  projectId   String
  name        String
  description String?
  order       Int
  startDate   DateTime?
  endDate     DateTime?
  isCompleted Boolean   @default(false)
  completedAt DateTime?
  createdAt   DateTime  @default(now())
  projects    Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  tareas      tareas[]

  @@index([projectId, order], map: "idx_fases_proyecto")
}

model hitos {
  id          String    @id
  projectId   String
  name        String
  description String?
  dueDate     DateTime
  status      String    @default("pendiente")
  progress    Int       @default(0)
  createdById String?
  completedAt DateTime?
  createdAt   DateTime  @default(now())
  projects    Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  tareas      tareas[]

  @@index([dueDate], map: "idx_hitos_fecha_limite")
  @@index([projectId], map: "idx_hitos_proyecto")
}

model tareas {
  id                                                              String                @id
  projectId                                                       String
  phaseId                                                         String?
  milestoneId                                                     String?
  title                                                           String
  description                                                     String?
  status                                                          String                @default("backlog")
  priority                                                        String                @default("media")
  assignedToId                                                    String?
  reportedById                                                    String?
  dueDate                                                         DateTime?
  estimatedHours                                                  Decimal?              @db.Decimal(5, 2)
  spentHours                                                      Decimal?              @db.Decimal(5, 2)
  order                                                           Int?
  createdAt                                                       DateTime              @default(now())
  updatedAt                                                       DateTime
  completedAt                                                     DateTime?
  deletedAt                                                       DateTime?
  adjuntos_tarea                                                  adjuntos_tarea[]
  comentarios_tarea                                               comentarios_tarea[]
  dependencias_tareas_dependencias_tareas_dependsOnTaskIdTotareas dependencias_tareas[] @relation("dependencias_tareas_dependsOnTaskIdTotareas")
  dependencias_tareas_dependencias_tareas_taskIdTotareas          dependencias_tareas[] @relation("dependencias_tareas_taskIdTotareas")
  etiquetas_tareas                                                etiquetas_tareas[]
  hitos                                                           hitos?                @relation(fields: [milestoneId], references: [id])
  fases_proyecto                                                  fases_proyecto?       @relation(fields: [phaseId], references: [id])
  projects                                                        Project               @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([order], map: "idx_tareas_orden")
  @@index([projectId, status], map: "idx_tareas_proyecto_estado")
  @@index([dueDate, deletedAt], map: "idx_tareas_due_date_calendar")
}

model ProjectFavorite {
  id           String   @id @default(uuid())
  projectId    String
  userId       String
  createdAt    DateTime @default(now())
  lastAccessed DateTime @default(now())

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId])
  @@index([userId])
  @@map("project_favorites")
}

enum ProjectStatus {
  ACTIVE
  COMPLETED
  ARCHIVED
  ON_HOLD
}

enum ProjectRole {
  ADMIN
  MEMBER
  READER
}

enum TemplateType {
  SCRUM
  KANBAN
  SIMPLE
}

enum TemplateComplexity {
  SIMPLE
  MEDIUM
  COMPLEX
}

enum TemplateCategory {
  SOFTWARE
  MARKETING
  DESIGN
  OPERATIONS
  RESEARCH
  OTHER
}

enum TemplateIndustry {
  TECH
  FINANCE
  HEALTHCARE
  EDUCATION
  RETAIL
  MANUFACTURING
  OTHER
}

// ======= Teams module (equipos) =======
model Team {
  id           String    @id @default(uuid())
  name         String    @map("nombre")
  description  String?   @map("descripcion")
  links        String?   @map("enlaces") // JSON string array of links (optional)
  leaderId     String?   @map("lider_id")
  projectId    String?   @map("proyecto_id")
  isActive     Boolean   @default(true) @map("esta_activo")
  createdAt    DateTime  @default(now()) @map("fecha_creacion")
  updatedAt    DateTime  @updatedAt @map("fecha_actualizacion")
  deletedAt    DateTime? @map("fecha_eliminacion")

  leader       User?     @relation("TeamLeader", fields: [leaderId], references: [id], onDelete: SetNull)
  project      Project?  @relation(fields: [projectId], references: [id], onDelete: SetNull)
  members      TeamMember[]
  invitations  TeamInvitation[]
  channels      Channel[]
  callRooms     CallRoom[]

  @@index([projectId], map: "idx_equipos_proyecto")
  @@index([leaderId], map: "idx_equipos_lider")
  @@map("equipos")
}

model TeamMember {
  id         String   @id @default(uuid())
  teamId     String   @map("equipo_id")
  userId     String   @map("usuario_id")
  role       String   @map("rol")
  joinedAt   DateTime @default(now()) @map("fecha_union")
  leftAt     DateTime? @map("fecha_salida")

  team       Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId])
  @@index([teamId], map: "idx_miembros_equipo_equipo")
  @@index([userId], map: "idx_miembros_equipo_usuario")
  @@map("miembros_equipo")
}

model TeamInvitation {
  id           String   @id @default(uuid())
  teamId       String   @map("equipo_id")
  email        String
  invitedById  String?  @map("invitado_por")
  role         String
  token        String   @unique
  status       String   @default("pendiente") @map("estado")
  expiresAt    DateTime @map("expira_en")
  acceptedAt   DateTime? @map("fecha_aceptacion")
  createdAt    DateTime @default(now()) @map("fecha_creacion")

  team         Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  invitedBy    User?    @relation(fields: [invitedById], references: [id], onDelete: SetNull)

  @@index([token], map: "idx_invitaciones_token")
  @@index([email, status], map: "idx_invitaciones_email_estado")
  @@map("invitaciones_equipo")
}

model TeamPermission {
  id         String   @id @default(uuid())
  teamId     String   @map("equipo_id")
  userId     String   @map("usuario_id")
  permissionId String @map("permiso_id")
  grantedBy  String?  @map("otorgado_por")
  expiresAt  DateTime? @map("expira_en")
  createdAt  DateTime @default(now()) @map("fecha_creacion")

  @@unique([teamId, userId, permissionId])
  @@index([teamId, userId], map: "idx_permisos_equipo_usuario")
  @@map("permisos_equipo")
}

// ======= Communication module (canales, mensajes, presencia) =======
model Channel {
  id          String    @id @default(uuid())
  name        String    @map("nombre")
  description String?   @map("descripcion")
  type        String    @map("tipo")
  projectId   String?   @map("proyecto_id")
  teamId      String?   @map("equipo_id")
  isPrivate   Boolean   @default(false) @map("es_privado")
  createdById String?   @map("creado_por")
  createdAt   DateTime  @default(now()) @map("fecha_creacion")
  deletedAt   DateTime? @map("fecha_eliminacion")

  project     Project?  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  team        Team?     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  createdBy   User?     @relation(fields: [createdById], references: [id], onDelete: SetNull)
  members     ChannelMember[]
  messages    Message[]
  presences    Presence[]

  @@index([projectId], map: "idx_canales_proyecto")
  @@index([teamId], map: "idx_canales_equipo")
  @@map("canales")
}

model ChannelMember {
  channelId String @map("canal_id")
  userId    String @map("usuario_id")
  role      String @default("miembro")
  joinedAt  DateTime @default(now()) @map("fecha_union")

  channel   Channel @relation(fields: [channelId], references: [id], onDelete: Cascade)
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([channelId, userId])
  @@index([userId], map: "idx_miembros_canal_usuario")
  @@map("miembros_canal")
}

model Message {
  id           String   @id @default(uuid())
  channelId    String   @map("canal_id")
  userId       String?  @map("usuario_id")
  content      String   @map("contenido")
  messageType  String   @default("texto") @map("tipo_mensaje")
  parentId     String?  @map("mensaje_padre_id")
  isEdited     Boolean  @default(false) @map("esta_editado")
  editedAt     DateTime? @map("fecha_edicion")
  createdAt    DateTime  @default(now()) @map("fecha_creacion")
  deletedAt    DateTime? @map("fecha_eliminacion")

  channel      Channel  @relation(fields: [channelId], references: [id], onDelete: Cascade)
  user         User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  parent       Message? @relation("MessageToParent", fields: [parentId], references: [id], onDelete: Cascade)
  children     Message[] @relation("MessageToParent")
  reactions    Reaction[]

  @@index([channelId, createdAt], map: "idx_mensajes_canal_fecha")
  @@index([parentId], map: "idx_mensajes_padre")
  @@map("mensajes")
}

model Reaction {
  id        String   @id @default(uuid())
  messageId String   @map("mensaje_id")
  userId    String   @map("usuario_id")
  emoji     String   @map("emoji")
  createdAt DateTime @default(now()) @map("fecha_creacion")

  message   Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId, emoji])
  @@index([messageId], map: "idx_reacciones_mensaje")
  @@map("reacciones_mensaje")
}

model Presence {
  userId       String   @id @map("usuario_id")
  channelId    String?  @map("canal_id")
  status       String   @default("desconectado") @map("estado")
  isTyping     Boolean  @default(false) @map("esta_escribiendo")
  lastActivity DateTime @default(now()) @map("ultima_actividad")
  updatedAt    DateTime @default(now()) @map("fecha_actualizacion")

  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  channel      Channel? @relation(fields: [channelId], references: [id], onDelete: SetNull)

  @@index([channelId], map: "idx_presencia_canal")
  @@map("presencia_usuario")
}

// Simple friendships table for user-to-user contacts (unidirectional)
model Friendship {
  id        String   @id @default(uuid())
  userId    String
  friendId  String
  status    String   @default("accepted")
  createdAt DateTime @default(now())

  user   User @relation("FriendUser", fields: [userId], references: [id], onDelete: Cascade)
  friend User @relation("FriendTarget", fields: [friendId], references: [id], onDelete: Cascade)

  @@unique([userId, friendId])
  @@index([userId], map: "idx_friendships_user")
  @@map("friendships")
}

// ======= Call Rooms module (salas de llamada) =======
model CallRoom {
  id          String   @id @default(uuid())
  name        String?  @map("nombre")
  teamId      String   @map("equipo_id")
  createdBy   String   @map("creado_por")
  isActive    Boolean  @default(true) @map("esta_activa")
  startedAt   DateTime @default(now()) @map("fecha_inicio")
  endedAt     DateTime? @map("fecha_fin")
  createdAt   DateTime @default(now()) @map("fecha_creacion")

  team         Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  creator      User     @relation("CallRoomCreator", fields: [createdBy], references: [id], onDelete: Cascade)
  participants CallParticipant[]

  @@index([teamId], map: "idx_sala_equipo")
  @@index([isActive], map: "idx_sala_activa")
  @@map("salas_llamada")
}

model CallParticipant {
  id          String   @id @default(uuid())
  roomId      String   @map("sala_id")
  userId      String   @map("usuario_id")
  isMuted     Boolean  @default(false) @map("esta_muteado")
  isVideoOff  Boolean  @default(false) @map("video_apagado")
  joinedAt    DateTime @default(now()) @map("fecha_union")
  leftAt      DateTime? @map("fecha_salida")

  room        CallRoom @relation(fields: [roomId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([roomId], map: "idx_participante_sala")
  @@index([userId], map: "idx_participante_usuario")
  @@map("participantes_llamada")
}
